import React, { useState, useEffect, useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';

// --- Utility Functions for Data Analysis ---

/**
 * Parses the raw CSV text data into a structured array of draw objects.
 * @param {string} csvText - The raw content of the CSV file.
 * @returns {Array<{date: string, numbers: number[], powerball: number, multiplier: number}>}
 */
const parseCsvData = (csvText) => {
    const lines = csvText.split('\n');
    // Skip the header row and any empty lines
    const dataLines = lines.slice(1).filter(line => line.trim().length > 0);

    return dataLines.map(line => {
        // Example line: "09/26/2020,11 21 27 36 62 24,3"
        const parts = line.split(',');
        if (parts.length < 3) return null;

        const date = parts[0].trim();
        const numbersString = parts[1].trim();
        const multiplier = parseInt(parts[2].trim(), 10) || 0;

        const allNumbers = numbersString.split(' ').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));

        if (allNumbers.length === 6) {
            // The first 5 are white balls, the last one is the Powerball
            const numbers = allNumbers.slice(0, 5);
            const powerball = allNumbers[5];

            return {
                date,
                numbers, // Array of 5 main numbers
                powerball, // Single powerball number
                multiplier
            };
        }
        return null;
    }).filter(draw => draw !== null); // Filter out any invalid lines
};

/**
 * Calculates the frequency of each main number and Powerball number.
 * @param {Array<{numbers: number[], powerball: number}>} draws - The parsed draw data.
 * @returns {{mainFrequencies: Array<{name: number, count: number}>, powerballFrequencies: Array<{name: number, count: number}>}}
 */
const calculateFrequencies = (draws) => {
    const mainCounts = {};
    const powerballCounts = {};

    draws.forEach(draw => {
        // Main Numbers (1-69)
        draw.numbers.forEach(num => {
            mainCounts[num] = (mainCounts[num] || 0) + 1;
        });

        // Powerball Number (1-26)
        powerballCounts[draw.powerball] = (powerballCounts[draw.powerball] || 0) + 1;
    });

    const mainFrequencies = Object.entries(mainCounts)
        .map(([name, count]) => ({ name: parseInt(name, 10), count }))
        .sort((a, b) => a.name - b.name); // Sort numerically

    const powerballFrequencies = Object.entries(powerballCounts)
        .map(([name, count]) => ({ name: parseInt(name, 10), count }))
        .sort((a, b) => a.name - b.name);

    return { mainFrequencies, powerballFrequencies };
};

/**
 * Calculates descriptive statistics for the sum of the 5 main numbers.
 * @param {Array<{numbers: number[]}>} draws - The parsed draw data.
 * @returns {{min: number, max: number, average: number, median: number}}
 */
const calculateSumStats = (draws) => {
    const sums = draws.map(draw => draw.numbers.reduce((sum, num) => sum + num, 0));

    if (sums.length === 0) return { min: 0, max: 0, average: 0, median: 0 };

    sums.sort((a, b) => a - b);
    const min = sums[0];
    const max = sums[sums.length - 1];
    const totalSum = sums.reduce((acc, s) => acc + s, 0);
    const average = totalSum / sums.length;

    const mid = Math.floor(sums.length / 2);
    const median = sums.length % 2 === 0
        ? (sums[mid - 1] + sums[mid]) / 2
        : sums[mid];

    return { min, max, average: parseFloat(average.toFixed(2)), median };
};

/**
 * Calculates the total count of odd and even main numbers across all draws.
 * @param {Array<{numbers: number[]}>} draws - The parsed draw data.
 * @returns {{odd: number, even: number}}
 */
const calculateOddEvenSplit = (draws) => {
    let oddCount = 0;
    let evenCount = 0;

    draws.forEach(draw => {
        draw.numbers.forEach(num => {
            if (num % 2 === 0) {
                evenCount += 1;
            } else {
                oddCount += 1;
            }
        });
    });

    return { odd: oddCount, even: evenCount };
};


// --- React Component ---

const App = () => {
    const [drawData, setDrawData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const CSV_FILE_PATH = 'Lottery_Powerball_Winning_Numbers__Beginning_2010.csv';

    // 1. Data Fetching and Parsing Effect
    useEffect(() => {
        const fetchAndParseData = async () => {
            try {
                setLoading(true);
                // The filename is now known to be available in the environment
                const response = await fetch(CSV_FILE_PATH); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. Make sure the file "${CSV_FILE_PATH}" is uploaded.`);
                }
                const csvText = await response.text();
                const parsedData = parseCsvData(csvText);

                if (parsedData.length === 0) {
                    throw new Error("Could not parse any valid data from the CSV file. Check file format.");
                }

                setDrawData(parsedData);
                setError(null);
            } catch (err) {
                console.error("Failed to load or parse data:", err);
                setError(err.message || "Failed to load historical data. Check the console for details.");
            } finally {
                setLoading(false);
            }
        };

        fetchAndParseData();
    }, []);

    // 2. Memoized Analysis Results
    const { mainFrequencies, powerballFrequencies } = useMemo(() => {
        return calculateFrequencies(drawData);
    }, [drawData]);

    const sumStats = useMemo(() => {
        return calculateSumStats(drawData);
    }, [drawData]);

    const oddEvenSplit = useMemo(() => {
        return calculateOddEvenSplit(drawData);
    }, [drawData]);

    // NEW: Calculate the date range of the currently analyzed data
    const dateRange = useMemo(() => {
        if (drawData.length === 0) return { earliest: 'N/A', latest: 'N/A' };
        
        // Convert 'MM/DD/YYYY' strings to Date objects for proper sorting/comparison
        const dates = drawData
            .map(d => {
                const parts = d.date.split('/');
                // Format as YYYY-MM-DD for reliable Date object creation
                return new Date(`${parts[2]}-${parts[0]}-${parts[1]}`);
            })
            .sort((a, b) => a - b); // Sort ascending to find min/max

        const earliestDate = dates[0];
        const latestDate = dates[dates.length - 1];
        
        // Simple MM/DD/YYYY format for display
        const formatDate = (date) => {
            if (!date || isNaN(date.getTime())) return 'N/A';
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        };

        return { 
            earliest: formatDate(earliestDate), 
            latest: formatDate(latestDate) 
        };
    }, [drawData]);

    // Calculate Average Frequency for the Reference Line
    const totalDraws = drawData.length;
    // 5 balls drawn per draw across all numbers (1-69)
    const averageMainFrequency = totalDraws > 0 ? (totalDraws * 5) / 69 : 0; 
    // 1 powerball drawn per draw across all powerball numbers (1-26)
    const averagePowerballFrequency = totalDraws > 0 ? totalDraws / 26 : 0; 


    // --- Components for Rendering ---

    const StatsCard = ({ title, value, unit = '' }) => (
        <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-xl">
            <p className="text-sm font-semibold text-gray-500">{title}</p>
            <p className="text-3xl font-bold text-indigo-700 mt-1">{value} {unit}</p>
        </div>
    );

    const FrequencyChart = ({ data, title, color, averageFrequency }) => (
        <div className="w-full h-80 bg-white p-4 rounded-xl shadow-lg border border-gray-100">
            <h3 className="text-lg font-bold text-gray-800 mb-4">{title} ({data.length} unique numbers)</h3>
            <ResponsiveContainer width="100%" height="85%">
                <BarChart data={data} margin={{ top: 5, right: 10, left: -20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                    <XAxis dataKey="name" stroke="#333" interval="preserveStartEnd" tickLine={false} />
                    <YAxis dataKey="count" stroke="#333" allowDecimals={false} tickLine={false} />
                    <Tooltip
                        contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                        formatter={(value, name, props) => [`${value} Draws`, 'Frequency']}
                    />
                    <Bar dataKey="count" fill={color} radius={[4, 4, 0, 0]} />
                    {averageFrequency > 0 && (
                        <ReferenceLine 
                            y={averageFrequency} 
                            stroke="#EF4444" // Red color
                            strokeDasharray="5 5"
                            label={{ value: `Avg: ${averageFrequency.toFixed(1)}`, position: 'right', fill: '#EF4444' }} 
                        />
                    )}
                </BarChart>
            </ResponsiveContainer>
        </div>
    );

    // --- Main Render Logic ---

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="text-xl font-medium text-indigo-600 p-8 rounded-xl shadow-2xl bg-white animate-pulse">
                    Loading and Parsing Powerball Data from CSV...
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-red-50">
                <div className="text-center p-8 rounded-xl shadow-2xl bg-white">
                    <h2 className="text-2xl font-bold text-red-600 mb-4">Data Error</h2>
                    <p className="text-gray-700">{error}</p>
                    <p className="text-sm text-gray-500 mt-4">Please ensure the file "{CSV_FILE_PATH}" is uploaded and correctly formatted.</p>
                </div>
            </div>
        );
    }


    return (
        <div className="min-h-screen bg-gray-50 font-sans p-4 sm:p-8">
            <script src="https://cdn.tailwindcss.com"></script>
            <style>{`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
                .font-sans { font-family: 'Inter', sans-serif; }
            `}</style>

            <header className="mb-8">
                <h1 className="text-4xl font-extrabold text-gray-900 text-center mb-2">
                    Powerball Data Analyzer
                </h1>
                <p className="text-center text-gray-600">
                    Analysis based on <span className="font-bold text-indigo-700">{totalDraws}</span> historical draws loaded from <code className="bg-gray-200 p-1 rounded-md text-sm">{CSV_FILE_PATH}</code>.
                    <br/>
                    <span className="text-sm text-gray-500">
                        Data Range: <span className="font-semibold text-gray-700">{dateRange.earliest}</span> - <span className="font-semibold text-gray-700">{dateRange.latest}</span>
                    </span>
                </p>
            </header>

            {/* General Stats Section */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <StatsCard title="Total Draws Analyzed" value={totalDraws} />
                <StatsCard title="Total White Balls Drawn" value={totalDraws * 5} />
                <StatsCard title="Total Odd Numbers" value={oddEvenSplit.odd} />
                <StatsCard title="Total Even Numbers" value={oddEvenSplit.even} />
            </div>

            {/* Sum Statistics Section */}
            <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Main Number Sum Statistics (5 Balls)</h2>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                <StatsCard title="Min Sum" value={sumStats.min} />
                <StatsCard title="Max Sum" value={sumStats.max} />
                <StatsCard title="Average Sum" value={sumStats.average} />
                <StatsCard title="Median Sum" value={sumStats.median} />
            </div>

            {/* Frequency Charts Section */}
            <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Ball Frequency Distribution</h2>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <FrequencyChart
                    title="Main Number Frequencies (1-69)"
                    data={mainFrequencies}
                    color="#4F46E5"
                    averageFrequency={averageMainFrequency} // Added average line
                />
                <FrequencyChart
                    title="Powerball Frequencies (1-26)"
                    data={powerballFrequencies}
                    color="#DC2626"
                    averageFrequency={averagePowerballFrequency} // Added average line
                />
            </div>

            <footer className="mt-12 text-center text-gray-500 text-sm">
                <p>Data loaded successfully and analysis is complete.</p>
            </footer>
        </div>
    );
};

export default App;
